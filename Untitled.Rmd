---
title: "Sector Rotation In the Stock Market"
author: "Niyog"
date: "2025-11-04"
output: html_document
---

**Introduction**

      Investors often talk about “money moving around the market” but what does that really mean? Over the past two decades, the U.S. stock market has gone through some of the most volatile periods in modern history. From the bursting of the dot-com bubble in the early 2000s, to the 2008 financial crisis, to the COVID-19 crash and recovery and finally the inflation driven rate hikes of 2022/2023. Through all of these, one thing has remained consistent: money never leaves the market, it simply rotates between sectors.
      
      This project explores how different sectors of the S&P 500 have performed during these major market cycles. We’ll look at which sectors investors fled to during crashes and which ones led the recoveries, painting a picture of how capital shifts between defensive and cyclical parts of the economy.

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse) #for data manipulation
library(tidyquant) #to pull financial data from Yahoo Finance
library(lubridate) # to handle dates
library(zoo) #for rolling calculations
```

First, I will load the data for all S&P 500 sector ETFs from Yahoo Finance and save it under a new variable.  
Each ticker (like **XLK**, **XLF**, or **XLE**) represents one major sector of the S&P 500.  
We’ll collect daily price data from **2000–2025**.

```{r load-data}
# Reading sector ETF data from Yahoo Finance
# Using tidyquant to pull multiple tickers at once

etfs <- c("XLK","XLF","XLV","XLE","XLY","XLP","XLI","XLU","XLB","XLRE","XLC")

sector_data <- tq_get(etfs,
                      from = "2000-01-01",
                      to   = "2025-12-31") %>%
  group_by(symbol)

glimpse(sector_data)
unique(sector_data$symbol)

```
**Check for missing values**
Let's check if there are any missing values.

```{r check missing}
#to check if there are any missing values in the dataset. 
colSums(is.na(sector_data))

```
So that means there are no missing data. 

**Extracting Key Columns**

Since the dataset contains no missing values, the next step is to extract only the variables that are essential for our analysis. Keeping unnecessary fields adds noise and makes the workflow less efficient. For this project, the core columns are:

**Symbol** – identifies the ETF/sector associated with each observation

**Date** – the corresponding trading date

**Adjusted** – the adjusted closing price, which is the most reliable metric for time-series and return analysis. 

These variables provide all the information required for analyzing sector performance over time.

```{r cleaning columns}
sector_data <- sector_data %>%
  select(symbol, date, adjusted)
glimpse(sector_data)
```
**Creating a “Year” Column**

With the essential variables extracted, the next step is to create a year column. This allows us to group and compare performance on an annual basis, making year-over-year analysis more meaningful.
```{r Year Column}
library(lubridate)
sector_data <- sector_data %>%
  mutate(year = year(date))
glimpse(sector_data)
```
Now we can easily group data by year later. 

**Calculating Daily Returns**
This step generates a new column **daily_return** which captures day-to-day percentage cahnge in teh adjusted closing price of each ETF. By calculating how much price moves in a trading day, we can measure short term performance, identify volatility patterns and prepare data for more advanced analysis. 

```{r daily-returns}
sector_data <- sector_data %>%
  group_by(symbol) %>%
  arrange(date) %>%
  mutate(daily_return = (adjusted - lag(adjusted)) / lag(adjusted))
glimpse(sector_data)
```
This creates a new column **daily_return** for each ETF, showing its daily percentage change.  

**Removing NA values**
Since the first trading day for each ETF has no prior price to compare against, its daily_return value is NA. These rows do not contribute to our analysis, so we remove them to keep the dataset clean.

```{r Removing NA}
sector_data <- sector_data %>%
  drop_na(daily_return)
glimpse(sector_data)

```
Now we can confirm that all NA values have been removed, leaving us with a clean set of valid daily returns for analysis.

**Let's see if each ETF has data for multiple years**
```{r check years}
sector_data %>%
  group_by(symbol) %>%
  summarise(start = min(date), end = max(date))
glimpse(sector_data)
```
**Now everything looks good and the data’s all set. Time to start asking some questions.**

  **1. How have different sectors performed over time?**
Over the years, sector ETFs have shown unique patterns of growth and decline shaped by economic cycles and investor sentiment.
By visualizing their performance over time, we can spot which sectors led the market and which lagged behind. 

```{r}
sector_trend <- sector_data %>%
  group_by(symbol) %>%
  arrange(date) %>%
  mutate(cumulative_return = (adjusted / first(adjusted)) - 1)

ggplot(sector_trend, aes(x=date, y=cumulative_return, color=symbol)) +
  geom_line() +
  labs(title="Cumulative Sector Returns (2000–2025)",
       y="Cumulative Return",
       x="Year",
       color="Sector") 
```
From the line graph we can see that Technology (XLK) and Consumer Discretionary (XLY) have outperformed other sectors over time, driven primarily by innovation. Energy (XLE) and Financials (XLF) showed more volatility, while Utilities (XLU) and Consumer Staples (XLP) stayed steady. Overall, sector leadership has rotated but tech and consumer sectors remain dominant long-term. 

**2. Which sectors performed best and worst each year?**
Every year different market conditions favor certain sectors. By comparing annual returns, we can see which sectors led the market and which lagged behind.

```{r}
#Calculating average yearly return
yearly_avg <- sector_data %>%
  group_by(symbol, year) %>%
  summarise(avg_return = mean(daily_return, na.rm = TRUE))

ggplot(yearly_avg, aes(x=year, y=avg_return, fill=symbol)) +
  geom_col(position="dodge") +
  labs(title="Average Yearly Returns by Sector", y="Avg Return") +
  theme_minimal()
```
This chart compares the average yearly returns of all sectors from 2000 to 2025, highlighting clear periods of market expansion and contraction. Technology (XLK) and Consumer Discretionary (XLY) frequently led in strong market years. During downturns such as the 2008 financial crisis and 2020 pandemic all sectors dipped together, though defensive ones like Utilities (XLU) and Consumer Staples (XLP) showed smaller declines. Overall,we can see how different sectors react to different economic cycles. High volatility sectors (like tech) lead the recovery while stable sectors(like utilities) keep the market stable in the long term. 

**3. How did sectors behave around major market events?**
Major market events often reveal how different sectors respond to stress and recovery.
Here, we examine sector trends around crises like the 2008 recession and the 2020 pandemic. 

```{r}
dotcom <- filter(sector_trend, year >= 1999 & year <= 2002)
crash2008 <- filter(sector_trend, year >= 2007 & year <= 2009)
covid <- filter(sector_trend, year >= 2019 & year <= 2021)

#dotcom crash
ggplot(dotcom, aes(x=date, y=cumulative_return, color=symbol)) +
  geom_line() +
  labs(title="Sector Behavior During the Dot-com Crash (1999–2002)",
       x="Date", y="Cumulative Return", color="Sector") 

#financial crisis of 2008
ggplot(crash2008, aes(x=date, y=cumulative_return, color=symbol)) +
  geom_line() +
  labs(title="Sector Behavior During the 2008 Financial Crisis (2007–2009)",
       x="Date", y="Cumulative Return", color="Sector") 

#Pandemic
ggplot(covid, aes(x=date, y=cumulative_return, color=symbol)) +
  geom_line() +
  labs(title="Sector Behavior During the COVID-19 Crash and Recovery (2019–2021)",
       x="Date", y="Cumulative Return", color="Sector") +
  theme_minimal()



```
Dot-com Crash 
During the dot-com crash, the Technology sector (XLK) suffered the steepest decline as the tech bubble burst, erasing massive gains from the late 1990s. Most other sectors, including Financials (XLF) and Industrials (XLI), also experienced losses but remained relatively stable compared to tech. Defensive sectors like Utilities (XLU) and Consumer Staples (XLP) were less affected.

2008 Financial Crisis
The 2008 crisis caused sharp declines across nearly all sectors with Financials (XLF) among the hardest hit due to the banking collapse. Energy (XLE) initially outperformed but later dropped as demand weakened. 

COVID Crash
The pandemic triggered a swift market crash in early 2020, followed by one of the fastest recoveries in history. Technology (XLK) and Consumer Discretionary (XLY) led the rebound as digital adoption increased during the lockdown period. Energy (XLE) initially collapsed due to reduced demand but rebounded later with economic reopening. Defensive sectors like Utilities (XLU) and Health Care (XLV) showed resilience throughout. This reflects investor preference for stability during uncertainty.

**4. Are some sectors more volatile than others?**
As we've seen in the previous graphs, different sectors move uniquely over time. Here, we analyze and compare the volatility of each sector to understand which ones experience greater fluctuations.

```{r}
#SD of daily returns
volatility <- sector_data %>%
  group_by(symbol, year) %>%
  summarise(sd_return = sd(daily_return, na.rm = TRUE))

#Boxplot
ggplot(sector_data, aes(x=symbol, y=daily_return, fill=symbol)) +
  geom_boxplot() +
  labs(title="Sector Volatility (Daily Returns)", y="Daily Return") +
  theme_minimal()

```
This chart shows how much each sector’s returns tend to swing on a daily basis. Energy (XLE) and Financials (XLF) are the most volatile, often reacting sharply to market changes. On the other hand, Utilities (XLU) and Consumer Staples (XLP) stay relatively calm, reflecting their steadier nature. Overall, growth sectors move more wildly while defensive ones are stable.

**How do sectors correlate with eachother?**

Understanding how sectors move in relation to each other helps reveal market connections and diversification opportunities. Here, we see the correlations using a heatmap. 

```{r}
#correlation
wide_returns <- sector_data %>%
  select(date, symbol, daily_return) %>%
  spread(symbol, daily_return)

cor_matrix <- cor(wide_returns[,-1], use="pairwise.complete.obs")

#heatmap
library(ggcorrplot) #for heatmap
ggcorrplot(cor_matrix, lab = TRUE, title="Correlation Between Sector Returns")

```

The heatmap shows that most sectors are strongly positively correlated, meaning they tend to move together. Industrial (XLI), Financials (XLF), and Consumer Discretionary (XLY) show some of the highest correlations, reflecting their sensitivity to overall economic trends. Defensive sectors like Utilities (XLU) and Consumer Staples (XLP) have lower correlations, suggesting they behave more independently during different market conditions. Overall, this indicates that while most sectors follow the broader market direction, stable ones can offer some diversification benefits.

**Conclusion**
Overall, the analysis shows that while all sectors move with the broader market, their performance and risk levels vary significantly over time. Technology (XLK) and Consumer Discretionary (XLY) have been the strongest long term performers, driven by innovation and shifting consumer habits. Energy (XLE) and Financials (XLF) remain more volatile, often leading during expansions but falling harder in downturns. Defensive sectors like Utilities (XLU) and Consumer Staples (XLP) provide stability especially during market crises. Correlation patterns reveal that most sectors move together, though defensive ones offer partial diversification. In short, market leadership rotates between different sectors, but a balanced portfolio across growth and defensive areas helps smooth returns and reduce overall risk.

